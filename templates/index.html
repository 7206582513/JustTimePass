<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SmartDoc Scholar</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <link href="https://fonts.cdnfonts.com/css/opendyslexic" rel="stylesheet">
  <style>
    body.dyslexia-mode {
      font-family: 'OpenDyslexic', sans-serif;
      background-color: #f9f9ff;
      font-size: 18px;
      letter-spacing: 0.05em;
      line-height: 1.6;
    }
  </style>
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
</head>
<body>
<div class="container mt-4">
  <h2 class="mb-3">üìò SmartDoc Scholar</h2>

  <button class="btn btn-sm btn-warning mb-3" id="toggle-dyslexia">üß† Toggle Dyslexia Mode</button>

  <form method="POST" enctype="multipart/form-data">
    <div class="form-group">
      <label>Upload PDF Notes</label>
      <input type="file" name="pdf" accept="application/pdf" class="form-control">
    </div>
    <button type="submit" class="btn btn-primary">Analyze PDF</button>
  </form>

  {% if summary %}
  <hr>
  <h4>üìù Summary (Bullet Points)</h4>
  <p id="summaryText">{{ summary.replace('\n', '<br>')|safe }}</p>
  <button class="btn btn-outline-info btn-sm mb-3" onclick="speakText('summaryText')">üîä Read Summary</button>

  <h5 class="mt-4">üîä Audio Summary</h5>
  <audio controls src="/audio"></audio>

  <h5 class="mt-4">üß† Interactive Quiz</h5>
  <div id="quiz-section">
    {% for q in questions %}
      <div class="mb-4">
        <p><strong id="question-{{ loop.index }}">{{ q.question }}</strong>
        <button class="btn btn-sm btn-outline-secondary" onclick="speakText('question-{{ loop.index }}')">üîä</button>
        </p>
        <div class="btn-group-toggle" data-toggle="buttons">
          {% for opt in q.options %}
            <button type="button" class="btn btn-outline-primary btn-sm option-btn mb-1"
                    data-answer="{{ q.answer }}" data-choice="{{ opt }}">
              {{ opt }}
            </button><br>
          {% endfor %}
        </div>
        <div class="feedback mt-2"></div>
      </div>
    {% endfor %}
  </div>

  <h5 class="mt-4">üí¨ Chat with Document</h5>
  <form id="chat-form">
    <input type="text" class="form-control mb-2" id="query" placeholder="Ask anything from PDF...">
    <button class="btn btn-success" type="submit">Ask</button>
  </form>
  <div id="chat-result" class="mt-3"></div>
  {% endif %}

  {% if history %}
  <hr>
  <h5>üìú Interaction History</h5>
  <button class="btn btn-outline-secondary mb-2" type="button" data-toggle="collapse" data-target="#historyCollapse">
    Show / Hide Chat History
  </button>
  <a href="/download_history" class="btn btn-sm btn-success float-right">üì• Download History</a>
  <div class="collapse" id="historyCollapse">
    <ul>
      {% for q, a, t in history %}
        <li><strong>{{ q }}</strong> ‚Üí {{ a }}<br><small>{{ t }}</small></li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}
</div>

<script>
  // Normalize strings for answer comparison
  function normalize(str) {
    if (!str) return '';
    return $("<textarea>").html(String(str)).text().replace(/\s+/g, " ").trim().toLowerCase();
  }

  // Quiz logic
  $('#quiz-section').on('click', '.option-btn', function () {
    const selected = $(this).data('choice');
    const correct = $(this).data('answer');

    const selectedNorm = normalize(selected);
    const correctNorm = normalize(correct);

    const isCorrect = selectedNorm === correctNorm;
    const allOptions = $(this).closest('.mb-4').find('.option-btn');
    const feedback = $(this).closest('.mb-4').find('.feedback');

    allOptions.prop('disabled', true);

    allOptions.each(function () {
      const choice = normalize($(this).data('choice'));
      if (choice === correctNorm) {
        $(this).removeClass('btn-outline-primary').addClass('btn-success');
      } else if (choice === selectedNorm) {
        $(this).removeClass('btn-outline-primary').addClass('btn-danger');
      }
    });

    if (isCorrect) {
      feedback.text("‚úÖ Correct! Great job.").css("color", "green");
    } else {
      feedback.text("‚ùå Incorrect. The correct answer is highlighted in green.").css("color", "red");
    }
  });

  // Chat form AJAX
  $('#chat-form').submit(function (e) {
    e.preventDefault();
    const query = $('#query').val();
    $.post('/chat', { query: query }, function (data) {
      $('#chat-result').html(`<strong>Response:</strong> ${data.response}`);
    });
  });

  // Dyslexia Mode Toggle
  $('#toggle-dyslexia').click(function () {
    $('body').toggleClass('dyslexia-mode');
  });

  // Read-aloud for any element by ID
  function speakText(id) {
    const content = document.getElementById(id).innerText;
    const synth = window.speechSynthesis;
    const utter = new SpeechSynthesisUtterance(content);
    utter.rate = 0.9;
    synth.speak(utter);
  }
</script>
</body>
</html>
