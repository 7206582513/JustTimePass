<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SmartDoc Scholar</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
</head>
<body>
  <div class="container mt-4">
    <h2 class="mb-3">üìò SmartDoc Scholar</h2>
    <form method="POST" enctype="multipart/form-data">
      <div class="form-group">
        <label>Upload PDF Notes</label>
        <input type="file" name="pdf" accept="application/pdf" class="form-control">
      </div>
      <button type="submit" class="btn btn-primary">Analyze PDF</button>
    </form>

    {% if summary %}
    <hr>
    <h4>üìù Summary (Bullet Points)</h4>
    <p>{{ summary.replace('\n', '<br>')|safe }}</p>

    <h5 class="mt-4">üîä Audio Summary</h5>
    <audio controls src="/audio"></audio>

    <h5 class="mt-4">üß† Interactive Quiz</h5>
    <div id="quiz-section">
      {% for q in questions %}
        <div class="mb-4">
          <p><strong>{{ q.question }}</strong></p>
          <div class="btn-group-toggle" data-toggle="buttons">
            {% for opt in q.options %}
              <button type="button" class="btn btn-outline-primary btn-sm option-btn mb-1"
                      data-answer="{{ q.answer }}" data-choice="{{ opt }}">
                {{ opt }}
              </button><br>
            {% endfor %}
          </div>
          <div class="feedback mt-2"></div>
        </div>
      {% endfor %}
    </div>

    <h5 class="mt-4">üí¨ Chat with Document</h5>
    <form id="chat-form">
      <input type="text" class="form-control mb-2" id="query" placeholder="Ask anything from PDF...">
      <button class="btn btn-success" type="submit">Ask</button>
    </form>
    <div id="chat-result" class="mt-3"></div>
    {% endif %}

    {% if history %}
    <hr>
    <h5>üìú Interaction History</h5>
    <button class="btn btn-outline-secondary mb-2" type="button" data-toggle="collapse" data-target="#historyCollapse">
      Show / Hide Chat History
    </button>
    <a href="/download_history" class="btn btn-sm btn-success float-right">üì• Download History</a>
    <div class="collapse" id="historyCollapse">
      <ul>
        {% for q, a, t in history %}
          <li><strong>{{ q }}</strong> ‚Üí {{ a }}<br><small>{{ t }}</small></li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}
  </div>
<script>
  function normalize(str) {
    if (!str) return '';
    return $("<textarea>").html(String(str)).text().replace(/\\s+/g, " ").trim().toLowerCase();
  }

  $('#quiz-section').on('click', '.option-btn', function () {
    const selected = $(this).data('choice');
    const correct = $(this).data('answer');

    const selectedNorm = normalize(selected);
    const correctNorm = normalize(correct);

    console.log("üü¢ SELECTED:", selectedNorm);
    console.log("‚úÖ CORRECT:", correctNorm);

    const isCorrect = selectedNorm === correctNorm;

    const allOptions = $(this).closest('.mb-4').find('.option-btn');
    const feedback = $(this).closest('.mb-4').find('.feedback');

    allOptions.prop('disabled', true);

    allOptions.each(function () {
      const choice = normalize($(this).data('choice'));
      if (choice === correctNorm) {
        $(this).removeClass('btn-outline-primary').addClass('btn-success');
      } else if (choice === selectedNorm) {
        $(this).removeClass('btn-outline-primary').addClass('btn-danger');
      }
    });

    if (isCorrect) {
      feedback.text("‚úÖ Correct! Great job.").css("color", "green");
    } else {
      feedback.text("‚ùå Incorrect. The correct answer is highlighted in green.").css("color", "red");
    }
  });

  $('#chat-form').submit(function (e) {
    e.preventDefault();
    const query = $('#query').val();
    $.post('/chat', { query: query }, function (data) {
      $('#chat-result').html(`<strong>Response:</strong> ${data.response}`);
    });
  });
</script>

</body>
</html>
